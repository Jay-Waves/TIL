可以安装 orcale 提供的虚拟机镜像 (内含 oracle): [oracle developer](https://www.oracle.com/database/technologies/databaseappdev-vm.html)

# 1 概念:

PDB (Pluggable Database): 可插入数据库容器, 其中的用户共享物理数据库资源.

CDB$root (Container Database): CDB是一个容纳多个PDB的容器. 先创建CDB, 然后向其中添加多个PDB. oracle 默认存在.

用户 (User): 一个数据库账户, 有自身登录凭证. 

角色 (Role): 一组相关的权限集合, 但不是一个账户. 类似"群组", 管理员为多个用户指定某个抽象的"角色", 方便同一管理和分配权限.

SID (Oracle System Identifier): **唯一**关联一个数据库. 服务 (Service) 则是一个全局数据库名称 (host:port/service_name), 数据库和服务是多对多关系.

orcale XE c21 版本默认包含一个根CDB (用 xe 服务连接), 以及一个PDB (用 xepdb1 服务连接).

**orcale区分大小写**

# 2 工具

### `sqlplus` 

`sqlplus <username>/<password> @<connect_identifier> as <role>`
- `connect_identifier`: 指向一个服务, 服务映射一个数据库 容器, 该映射通过 tnsnames.ora 规定.

`sqlplus /nolog` 不登录直接进入命令环境

#### 登录方式:

**connect locally using OS authentication**: `sqlplus / as sysdba`

**easy connect naming method**: 无需配置 tnsnames.ora 文件, `sqlplus <user>/<passwd>@//<database_host><:port>/<service_name> as sysdba`, `service_name` 指具体数据库名, 没有则使用 listener.ora 配置文件中的 `DEFAULT_SERVICE_listener_name`

**Net Services Listener and Default Services**: 需要 tnsnames.ora 文件, `sql <user>/<pwd>@<tns_name_alias>`

不需要管理员权限时, 不要加 `as sysdba`, 否则一切操作都会在sys级别操作, 而不是用户级别. (比如建立的表不在ot下, 而在sys下)

#### 样例:

```shell
sqlplus scott/tiger@localhost:1521/ORCL 

# PDB 
sqlplus sys@localhost/xepdb1 as sysdba 

# CDB$ROOT 
sqlplus sys@localhost/xe as sysdba

# 检查用户是否配置正确
tns_panding <user>
```

### `lsnrctl` 

设置监听服务

`lsnrctl status` 当前状态

`lsnrctl start [listener-name]` 启动监听器

`lsnrctl stop [listener-name` 关闭监听器

`lsnrctl reload` 重启监听器

`lsnrctl hep` 帮助

# 3 配置文件

windows 注册表中会有 XEc21 的一些环境变量:

注册表位置 `HKEY_LOCAL_MACHINE\SOFTWARE\Oracle\KEY_OraDB21Home1`

- `ORACLE_SID`: Oracle 实例的名称, 安装是指定, 对 Oracle XE 21c, 其值为 XE, 不可以修改. 
- `ORACLE_HOME`: Oracle 安装的 home 目录, 很多配置文件均以他作为相对目录的起点. 
- `NLS_LAANG`: 安装的数据库缺省的语言和字符集编码 
- `TNS_ADMIN`: 可手动指定 tnsnames.ora 文件的位置. 缺省位置是 `%oracle_home%/network/admin` 目录.

网络配置文件位置: `%oracle_base%/homes/%oracle_home_name%/network/admin`
- sqlnet.ora: 配置身份认证方式, 网络连接名字查找方式
- listener.ora: 配置监听器
- tnsname.ora: 配置客户端连接别名, 类似 `/etc/hosts`. 用户借此可以便捷访问数据库, 自动化连接步骤.

### 修改日期格式:

```sql
ALTER SESSION SET NLS_DATE_LANGUAGE = 'ENGLISH';

ALTER SESSION SET NLS_DATE_LANGUAGE = 'SIMPLIFIED CHINESE';

select sysdate from dual;
```

# 4 授权

## 角色 Role

oracle内置角色:

**CONNECT**:

较新版本中, connect角色仅有基础连接权限:
- `CREATE SESSION`: 允许用户连接到数据库.

**RESOURCE**:
    
此角色是为开发人员设计的, 提供了创建和管理模式对象的基本权限, 但不允许用户对其他用户的对象进行操作. 包括以下权限:
    
- `CREATE TABLE`: 允许用户创建表.
- `CREATE CLUSTER`: 允许用户创建群集.
- `CREATE SEQUENCE`: 允许用户创建序列.
- `CREATE PROCEDURE`: 允许用户创建存储过程, 函数和包.
- `CREATE TRIGGER`: 允许用户创建触发器.
- `CREATE TYPE`: 允许用户创建类型.
- 等...

**DBA**
    
一个高级角色, 为数据库管理员提供了几乎所有系统权限. 任何有此角色的用户几乎可以对数据库执行任何操作.

- 数据库管理和维护.
- 用户和权限管理.
- 表空间, 数据文件和存档管理.
- 备份和恢复

**SYSDBA**:

最高级别数据库权限, 由管理员使用. 有完全的控制和管理权限.

**SYSOPER**:

比 sysdba, 允许启动和停止数据库, 但是不允许查看用户数据或者修改库结构.

**SYSBACKUP**:

oracle 12c 引入的, 给予用户恢复和备份数据的权限.

## 用户 User

内置用户 (user): 
- `sys`: 有最高数据权限
- `system`
- `/` 默认空登录, OS authentification, 用当前操作系统用户登录.

查看当前用户: `SELECT USER FROM DUAL;`

# 5 命令

## 启动过程

启动过程有四个阶段
- `no service`: 没有 oracle 守护进程开启. (windows 上指服务, 在 services.msc 中看, 可设置为手动启动)
- `no mount`: 开启了oracle必要守护进程, 但是没有数据库被挂载.
- `mount`: 数据库已被挂载, 但未打开. 可以访问数据和控制文件, 但是不能执行sql操作. cdb先被挂载, 然后挂载其下的pdb.
- `open`: 正常操作

启动方法:
1. 手动开启所有 oracle 服务, OracleVssWriterXE 可以不启动
2. `sqlplus / as  sysdba`, 执行命令 `startup;`. 开启CDB.
3. 手动开启PDB, `alter pluggable database <name> open;`

关闭数据库:
1. `sqlplus / as sysdba`, 执行 `shutdown`. 这会自动卸载数据库, 并关闭oracle服务.
2. oracle 守护进程还是会进行, 但由于没有挂载数据库, 所以资源消耗很小.

基础命令: 
```sql
$ startup;

$ shutdown immediate;

-- 打开全部的 pdb
$ alter pluggable database all open;

-- 设置pdb自动挂载到cdb上:
sqlplus / as sysdba
$ alter pluggable database all oepn;
$ alter pluggable database all save state;

-- 切换服务
$ alter session set container = xepdb1;
$ alter session set cotainer = cdb$root;

$ desc table_name
```

## 执行sql脚本
基础命令:

```sql
$ start <file_name>    -- 执行sql脚本
$ /                    -- 执行上个sql命令
$ sqool <file_name>    -- 输出到指定文件, 此后所有的内容(包括用户输入, 都会写入文件)
$ sqool off
$ exit
```

## 用户管理

切换用户:
```sql
> connect ot/123456@xepdb1
```

## 输出设置

```sql
-- 分页时, oracle会重复输出标题, 可以关掉
set heading off

-- 页面大小(行数), 默认比较小
set pagesize 500

-- 行宽
set linesize 200

-- CHAR 限制列宽, a->alphanumeric
column col_name format a15
-- NUM 限制列宽, 99999->一数字一宽度, 也可以用00000
-- 还可以规定小数点和千分位: 9,999.99
column col_num format 999999 
-- 别名
column col_num heading col_num2 

-- 清除设置的输出格式
clear ...

-- 如果输出为 #####, 说明设置的列宽过小
```