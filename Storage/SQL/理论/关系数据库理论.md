关系模式五元组: $R(U, D, Dom, F)$
- 关系名 R
- U 为一组属性
- D 属性组 U 所来自的域
- Dom 为属性到域的映射
- F 为属性组 U 上的一组数据依赖 (约束关系)

简化为 $R(U,\ F)$, 其实例(某个关系, 即数据库)记为 r, r 包括很多数据元组 t (行).

# 定义

数据依赖包括: 函数依赖 (Functional Dependency, FD), 多值依赖 (Multi-Valued Dependency, MVD)

## 函数依赖

属性集 $X, Y$, 对 r 上**任意**两个元组 $t_{1}, t_{2}$: 如果 $t_{1}[X]=t_{2}[X]\Rightarrow t_{1}[Y]=t_{2}[Y]$, 则 $X\rightarrow Y$ (Y函数依赖于X)

若 $X\rightarrow Y$, $Y\rightarrow X$, 则记为 $X\leftarrow \rightarrow Y$

若 Y 不函数依赖于 X, 记为 $X\not\rightarrow Y$

若 $X\rightarrow Y$, 且对于 X 的任意真子集 $X'$, 都有 $X'\not\rightarrow Y$, 则称 Y 对 X 完全函数依赖, 记为 $X\stackrel{F}{\longrightarrow}Y$; 若 $X\rightarrow Y$, 且 Y 不完全函数依赖于 X, 则称 Y 对 X 部分函数依赖, 记为 $X\stackrel{P}{\longrightarrow}Y$

$R(U)$ 中, 如果 $X\rightarrow Y$, $Y\not\subseteq X$, $Y\not\rightarrow X$; $Y\rightarrow Z$, $Z\not\subseteq Y$, 则称 Z 对 X 传递函数依赖 (transitive functional dependency), 记 $X\stackrel{传递}{\longrightarrow}Z$. 如果 $Y\leftarrow \rightarrow X$, 则 Z 直接依赖于 X, 而不是传递依赖. **传递依赖存在非受控冗余**

## 多值依赖

多值依赖包括函数依赖, 

## 码/键 key

设 K 为 $R(U,\ R)$ 中的属性或属性组合, 若 $K\stackrel{F}{\rightarrow} U$, 则称 K 为 R 的一个**候选码 (candidate key)**. 从关系模式 R 中选出一个 K, 来作为主码 (primary key).
- 如果 $K\stackrel{P}{\rightarrow}U$, 则称 K 为超码 (Surpkey)
- 候选码是最小的超码, 即 $K\stackrel{F}{\rightarrow}U$

包含在任何一个候选码中的属性, 称为**主属性** (Prime attribute), 不包含在任何候选码中的属性称为**非主属性** (Nonprime attribute) 或非码属性 (Non-key attribute)

R 中整个属性组是码, 称为全码(All-key)

属性组 X 并非 R 的主码, 但是是另一个模式的主码, 则称 X 为 R 的**外码 (Foreign Key)**.

## Armstrong 公理系统

对于关系模式 $R(U,\ F)$, 其任何一个关系r, 若 $X\rightarrow Y$ 皆成立, 则称 F 蕴含 $X\rightarrow Y$.

对于 $R(U,\ F)$ 存在如下推理规则:
- A1 自反律 (reflexivity rule) 若 $Y\subseteq X\subseteq U$, 则 $X\rightarrow Y$ 为F所蕴含.
- A2 增广律 (augmentation rule) 若 $X\rightarrow Y$ 为F所蕴含, 且 $Z\subseteq U$, 则 $XZ\rightarrow YZ$ 为F所蕴含.
- A3 传递律 (transitivity rule) 若 $X\rightarrow Y$, $Y\rightarrow Z$ 为F所蕴含, 则 $X\rightarrow Z$ 为F所蕴含.

引理 (推理规则):
- 合并规则 (union rule) 若 $X\rightarrow Y$, $X\rightarrow Z$, 则 $X\rightarrow YZ$
- 伪传递规则 (pseudo transitivity rule) 若 $X\rightarrow Y$, $WY\rightarrow Z$, 则 $XW\rightarrow Z$
- 分解规则 (decomposition rule) 若 $X\rightarrow Y$, $Z\subseteq Y$, 则 $X\rightarrow Z$

## 范式

范式 (Normal Form, NF) 是符合某一种级别的关系模式的集合. 如关系模式R是第二范式, 记为 $R\in 2NF$. [Wikipedia](https://en.wikipedia.org/wiki/Database_normalization) 这里非常详细.

![|200](../../../-%20attach/Pasted%20image%2020231229160148.png)

$5NF\in 4NF\in BCNF\in 3NF\in 2NF\in 1NF$, 处于低级范式的关系模式, 通过模式分解 (schema decomposition) 转化为若干个高一级范式的关系模式集合, 该过程称为**规范化 Normalization**, 随着范式等级提高, **依次去除所有不依赖候选键的函数依赖**, 数据冗余减少, 但数据库结构复杂性和维护难度也提高.

| Constraint                                                                                                                                        | 1NF | 2NF | 3NF | BCNF | 4NF | 5NF | 
| ------------------------------------------------------------------------------------------------------------------------------------------------- | --- | --- | ---  | ---- | --- | --- |
| Unique rows (no duplicate records) <br> Scalar columns (columns cannot contain relations or composite values)                                     | y   | y   | y    | y    | y   | y   |
| Every non-prime attribute has a full functional dependency on a candidate key (attributes depend on the _whole_ of every key)                     | x   | y   | y    | y    | y   | y   |
| Every non-trivial functional dependency either begins with a superkey or ends with a prime attribute (attributes depend _only_ on candidate keys) | x   | x   | y   | y    | y    |  y   | y   |
| Every non-trivial functional dependency begins with a superkey (a stricter form of 3NF)                                                           | x   | x   | x    | y    |  y   | y   |
| Every non-trivial multivalued dependency begins with a superkey                                                                                   | x   | x   | x     | x    | y   | y   |
| Every join dependency has only superkey components                                                                                                | x   | x   | x   | x    | x   | y    |

### 1NF

表的每一属性都是不可分割的最小数据单位, 且关系中的每一元组都是唯一的.

### 2NF

若关系模式 $R\in 1NF$, 每个*非主属性*都完全依赖于*任何一个候选码*, 则$R\in 2NF$.

如果是单一候选键, 一定符合 2NF.

### 3NF

### BCNF

设关系模式 $R\langle U, F\rangle\in1NF$, 若 $X\rightarrow Y$ 且 $Y\not\subseteq X$ 时, X 必含有码, 则 $R\langle U, F\rangle\in BCNF$

换言之, $R\langle U, F\rangle$ 中, 如果每一个决定属性集都包含候选码 (超码), 则 $R\in CBNF$.

### 数据规范化例子

> from Wikipedia

#### Initial Data

|<u>ISBN</u>|Title|Author|Author Nationality|Format|Price|Subject|Pages|Thickness|Publisher|Publisher Country|Genre ID|Genre Name|
|--|---|---|---|---|---|---|---|---|---|---|---|---|
| 1590593324 |Beginning MySQL Database Design and Optimization|Chad Russell|American|Hardcover|49.99| \|MySQL \| <br> \|Database\| <br> \|Design \| |520|Thick|Apress|USA|1|Tutorial|


#### 1NF Data

**1NF:** A field may not contain a set of values or a nested record.

Book Table:

|~~ISBN~~|Title|Author|Author Nationality|Format|Price|Pages|Thickness|Publisher|Publisher Country|Genre ID|Genre Name|
|---|---|---|---|---|---|---|---|---|---|---|---|
|1590593324|Beginning MySQL Database Design and Optimization|Chad Russell|American|Hardcover|49.99|520|Thick|Apress|USA|1|Tutorial|

Subject Table: ISBN is a foreign key

| <u>ISBN</u>  |<u>Subject Name</u> |
| ---------- | ---------------- |
| 1590593324 | MySQL            |
| 1590593324 | Database         |
| 1590593324 | Design           |

#### 2NF Data

**not** 2NF Book Table: some attributes not full functional dependency on the **composite key: {Title, Format}**

|<u>Title</u>|<u>Format</u>|Author|Author Nationality|Price|Pages|Thickness|Publisher|Publisher Country|Genre ID|Genre Name|
|---|---|---|---|---|---|---|---|---|---|---|
|Beginning MySQL Database Design and Optimization|Hardcover|Chad Russell|American|49.99|520|Thick|Apress|USA|1|Tutorial|
|Beginning MySQL Database Design and Optimization|E-book|Chad Russell|American|22.34|520|Thick|Apress|USA|1|Tutorial|
|The Relational Model for Database Management: Version 2|E-book|E.F.Codd|British|13.88|538|Thick|Addison-Wesley|USA|2|Popular science|
|The Relational Model for Database Management: Version 2|Paperback|E.F.Codd|British|39.99|538|Thick|Addison-Wesley|USA|2|Popular science|

2NF Book Table: 所有非候选主键依赖于整个候选键

|<u>Title</u>|Author|Author Nationality|Pages|Thickness|Publisher|Publisher Country|Genre ID|Genre Name|
|---|---|---|---|---|---|---|---|---|
|Beginning MySQL Database Design and Optimization|Chad Russell|American|520|Thick|Apress|USA|1|Tutorial|
|The Relational Model for Database Management: Version 2|E.F.Codd|British|538|Thick|Addison-Wesley|USA|2|Popular science|

2NF Price Table: Price属性单独成表, 变相移除原对候选键的部分依赖 {Price} -> {Title, Format}

| <u>Title</u> | <u>Format</u> | Price |
| --- | --- | --- |
| Beginning MySQL Database Design and Optimization | Hardcover | 49.99 |
| Beginning MySQL Database Design and Optimization | E-book | 22.34 |
| The Relational Model for Database Management: Version 2 | E-book | 13.88 |
| The Relational Model for Database Management: Version 2 | Paperback | 39.99 |

#### 3NF Data

3NF Book Table:

| Title                                                   | Author       | Pages | Thickness | Publisher      | Genre ID |
| ------------------------------------------------------- | ------------ | ----- | --------- | -------------- | -------- |
| Beginning MySQL Database Design and Optimization        | Chad Russell | 520   | Thick     | Apress         | 1        |
| The Relational Model for Database Management: Version 2 | E.F.Codd     | 538   | Thick     | Addison-Wesley | 2        |

3NF Price Table: 和2NF中一致

| <u>Title</u> | <u>Format</u> | Price |
| --- | --- | --- |
| Beginning MySQL Database Design and Optimization | Hardcover | 49.99 |
| Beginning MySQL Database Design and Optimization | E-book | 22.34 |
| The Relational Model for Database Management: Version 2 | E-book | 13.88 |
| The Relational Model for Database Management: Version 2 | Paperback | 39.99 |

3NF Author Table: 移除原传递依赖 {Title} -> {Author} -> {Author Nationality}

| <u>Author</u>       | Author Nationality |
| ------------ | ------------------ |
| Chad Russell | American           |
| E.F.Codd     | British            |


3NF Publisher Table: 移除原传递依赖 {Title} -> {Publisher} -> {Publiserh Country}

| <u>Publisher</u> | Country |
| ---------------- | ------- |
| Apress           | USA     |
| Addison-Wesley   | USA     |


3NF Genre Table: 移除原传递依赖 {Title} -> {Genre ID} -> {Genre Name}

| Genre ID | Name            |
| -------- | --------------- |
| 1        | Tutorial        |
| 2        | Popular science |

#### BCNF Data

#### 4NF Data

BCNF Franchisee-Book-Location Table: assuming that all available books are offered in each area, the **Title** is not unambiguously bound to a certain **Location** and therefore the table doesn't satisfy 4NF

| Franchisee ID | Title                                                   | Location   |
| ------------- | ------------------------------------------------------- | ---------- |
| 1             | Beginning MySQL Database Design and Optimization        | California |
| 1             | Beginning MySQL Database Design and Optimization        | Florida    |
| 1             | Beginning MySQL Database Design and Optimization        | Texas      |
| 1             | The Relational Model for Database Management: Version 2 | California |
| 1             | The Relational Model for Database Management: Version 2 | Florida    |
| 1             | The Relational Model for Database Management: Version 2 | Texas      |
| 2             | Beginning MySQL Database Design and Optimization        | California |
| 2             | Beginning MySQL Database Design and Optimization        | Florida    |
| 2             | Beginning MySQL Database Design and Optimization        | Texas      |
| 2             | The Relational Model for Database Management: Version 2 | California |
| 2             | The Relational Model for Database Management: Version 2 | Florida    |
| 2             | The Relational Model for Database Management: Version 2 | Texas      |
| 3             | Beginning MySQL Database Design and Optimization        | Texas      |

4NF Franchisee-Book Table:

| Franchisee ID | Title                                                   |
| ------------- | ------------------------------------------------------- |
| 1             | Beginning MySQL Database Design and Optimization        |
| 1             | The Relational Model for Database Management: Version 2 |
| 2             | Beginning MySQL Database Design and Optimization        |
| 2             | The Relational Model for Database Management: Version 2 |
| 3             | Beginning MySQL Database Design and Optimization        |

4NF Franchisee-Location Table:

| Franchisee ID | Location   |
| ------------- | ---------- |
| 1             | California |
| 1             | Florida    |
| 1             | Texas      |
| 2             | California |
| 2             | Florida    |
| 2             | Texas      |
| 3             | Texas      |